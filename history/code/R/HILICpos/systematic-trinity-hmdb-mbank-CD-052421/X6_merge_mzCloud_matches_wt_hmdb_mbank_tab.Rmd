---
title: "X6_merge_mzCloud_matches_wt_hmdb_mbank_tab"
author: "Minghao Gong"
date: "6/7/2021"
output: html_document

---
# merging MS2 annotations together
- Locate not-collapsed hmdb/mbank MS2 summary table
- Locate the merged CD-exported & xcms table
  - Both these tables should already have the feature identifiers.
- read both tables
  - expand the table
- Select columns of and change column names for the designed format that is matched with hmdb/mbank
- 

# information that may be required for metDatamodel
```
templated on MONA JSON
            {"instrument": "",
            "precursor type": "M+H[1+]",
            "precursor m/z": 169,
            "collision energy": "30V",
            "score": 5.5,
            "spectrum": "59.000:0.615142 72.600:0.031546 74.600:0.015773 78.900:0.086751 85.200:1.490536 150.500:0.055205 166.000:0.055205 167.200:100.000000",
            },
            {},
            {}
```
```{r}
```


```{r}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
rm(list = ls())

```


```{r}
output_dir <- "../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/merge_mzCloud_wt_hmdb_mbank/"
dir.create(output_dir)
```

```{r}
hmdb_mbank_df <- read.csv("../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/test_sps_operation/hmdb_mbank_df_filledEmptyHmdbInfo_validPrecurMzCheck.csv")
colnames(hmdb_mbank_df)
```

```{r}
mzcloud_df <- read.csv("../../../../data/output/annotation-with-CD-exported-tables/sorted_filt_med_16.6_padj_0.05_FC_1/merged_matched_xcms_CDexported.csv")
colnames(mzcloud_df)
```

```{r}
refined_mzcloud_df <- mzcloud_df[,c("X","Name","Formula","Molecular.Weight","Compounds.ID","Annotation.Source..mzCloud.Search","m.z","RT..min.","X..mzCloud.Results","mzCloud.Best.Match","MS2","Background")]
only_ms2annot_refined_mzcloud_df <-refined_mzcloud_df[refined_mzcloud_df$Annotation.Source..mzCloud.Search != "No results",]
nrow(refined_mzcloud_df)
nrow(only_ms2annot_refined_mzcloud_df)
```


```{r}
colnames(hmdb_mbank_df)
```


```{r}
colnames(only_ms2annot_refined_mzcloud_df) <- c("featureIdCandidate","db_name","db_formula","db_exactmass","db_compound_id","validPrecursorMassCheck","db_precursorMz","rtime","mzcloud_matches_num","db_score","MS2runMode","IsBackground")
```

```{r}
only_ms2annot_refined_mzcloud_df$db_source <- "mzCloud"
```

```{r}
only_ms2annot_refined_mzcloud_df$rtime <- only_ms2annot_refined_mzcloud_df$rtime * 60
```

```{r}
only_ms2annot_refined_mzcloud_df$db_formula <- gsub('\\s+', '', only_ms2annot_refined_mzcloud_df$db_formula)
```



```{r}
merge_df <- rbind.fill(hmdb_mbank_df,only_ms2annot_refined_mzcloud_df)
```

```{r}
write.csv(merge_df,paste0(output_dir,"hmdb_mbank_mzcloud_matches.csv"))
```

# Collapse dataframe
```{r}
colnames(merge_df)
```

```{r}
#' excluding "X" and all the columns with "db_" prefix
columns_selected <- c("featureIdCandidate")
```


```{r}
# try to collapse dataframe
# detach(plyr) # This is critical to avoid single-row summary which is used in plyr
library(dplyr)
agg_df <- merge_df  %>% group_by(.dots = columns_selected) %>% summarize_each(funs(paste(., collapse = "; ")))  
# pathway_collapsed = paste(annotation, collapse = ";")
dim(agg_df)
dim(agg_df)
```
```{r}
head(agg_df)
```

# write the output data
```{r}
write.csv(agg_df,paste0(output_dir,"collapsed_merged_trio.csv"))
```

## A heatmap plugin
- This part is going to refine the `agg_df` by only selecting columns for heatmap
- Also, functions will involve create separate columns to denote annotation results from different databases (e.g., Full match, invalid mass and etc.)
- The name showed in the row should only contain those with full matches
- So essential column names will be:
  - featureIdCandidate √
  - name of the annotated compounds 
  - three columns, mzCloud_res, hmdb_res, massbank_res √

```{r}
hm_df <- merge_df[c("featureIdCandidate","db_name","db_source","validPrecursorMassCheck")]
head(hm_df)
```

```{r}
hm_df$db_source
```


```{r}
hm_df$mzcloud_res <- "NA"
hm_df$hmdb_res <- "NA"
hm_df$mbank_res <- "NA"

hm_df$mzcloud_res[hm_df$db_source == "mzCloud"] <- hm_df$validPrecursorMassCheck[hm_df$db_source == "mzCloud"]

hm_df$hmdb_res[hm_df$db_source == "hmdb"] <- hm_df$validPrecursorMassCheck[hm_df$db_source == "hmdb"]

hm_df$mbank_res[hm_df$db_source == "massbank"] <- hm_df$validPrecursorMassCheck[hm_df$db_source == "massbank"]

colnames(hm_df)
```



```{r}
library(dplyr)
columns_selected <- c("featureIdCandidate")
collapsed_hm_df <- hm_df  %>% group_by(.dots = columns_selected) %>% 
  summarize_each(funs(paste(., collapse = "; ")))  
# pathway_collapsed = paste(annotation, collapse = ";")
```


```{r}
removeNAstring <- function(x) {
  x <- sub(pattern = "NA; ","", x)
  x <- sub(pattern = "; NA","", x)
  x <- sub(pattern = "NA","", x)
  return(x)
}

collapsed_hm_df[,5:7] <- apply(collapsed_hm_df[,5:7],c(1, 2),removeNAstring)

l_of_name <- sapply(collapsed_hm_df$db_name,function(x)strsplit(x,"; "))
l_of_res <- sapply(collapsed_hm_df$validPrecursorMassCheck,function(x)strsplit(x,"; "))
```


```{r}
for (i in 1:length(l_of_name)) {
  if ("Invalid mass" %in% l_of_res[[i]]) {
    
    idx_invalid_mass <- which(l_of_res[[i]] == "Invalid mass")
    
    l_of_name[[i]][idx_invalid_mass] <- ""
    
    l_of_name[[i]] <- l_of_name[[i]][l_of_name[[i]]!= ""]
  }
}
collapsed_hm_df$refined_name <- sapply(l_of_name,function(x)paste(x, collapse = "; "))

```

```{r}
write.csv(collapsed_hm_df,paste0(output_dir,"collapsed_merged_trio4heatmap.csv"), row.names = FALSE)
```


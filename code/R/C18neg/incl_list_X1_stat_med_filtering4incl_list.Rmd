---
title: "Statistical filtering and median filtering for inclusion list"
output: html_notebook
dataset: RPneg reanalyzed from 04022021
keyword: 1st step of inclusion list generation
---


## Clean up the environment and load the library 

```{r, include=FALSE}
rm(list = ls())

library(xcms)
library(RColorBrewer)
library(pander)
library(magrittr)
library(pheatmap)
library(SummarizedExperiment)
library(dplyr)
library(tidyr)
library(ggpubr)
library(ggplot2)
```

## Load the data and have a look at

```{r}
getwd()
output_dir = "../../../data/output/RPneg_0402/filt_incl_list/"
dir.create(output_dir)

# load statistical test full report
ttest_df <- read.table("../../../data/output/RPneg_0402/ttest_equal/ttest_res_full_report_R5posvsR5neg.txt", 
                       header = TRUE, sep = '\t')
ttest_df[1:5,1:5]
colnames(ttest_df)
nrow(ttest_df)
```



## Create median across samples in each feature
```{r}
Med_thre <- 16.6 #log2-scale of 100,000
ttest_df$Median <- rowMedians(as.matrix(ttest_df[,13:21]),na.rm = TRUE)
# You can check by: ttest_df[1:10,c(13:21,ncol(ttest_df))]
nrow(ttest_df)
nrow(ttest_df[ttest_df$Median > Med_thre,])

```
- Most of the features are with median higher than than 100,000 integrated values. 



## Apply statistics and median filtering in each feature
- check both padj and Rawpval
```{r}
Med_thre <- 16.6 #log2-scale of 100,000
pval_thre <- 0.05

nrow(ttest_df)
nrow(ttest_df[ttest_df$pval < pval_thre & ttest_df$Median > Med_thre,])
nrow(ttest_df[ttest_df$padj < pval_thre & ttest_df$Median > Med_thre,])
```

```{r}
Med_thre <- 16.6 #log2-scale of 100,000
pval_thre <- 0.1

nrow(ttest_df)
nrow(ttest_df[ttest_df$pval < pval_thre & ttest_df$Median > Med_thre,])
nrow(ttest_df[ttest_df$padj < pval_thre & ttest_df$Median > Med_thre,])
```
- I decide to go with padj < 0.05 & Median of integrated intensity > 100,000 which include 307 to trim down.

### First set of filtering
```{r}
Med_thre <- 16.6 #log2-scale of 100,000
pval_thre <- 0.05

filt_df <- ttest_df[ttest_df$padj < pval_thre & ttest_df$Median > Med_thre,]
dim(filt_df)
```


## Supplementary: include the fold change

### Read the table if needed.
```{r}
if(FALSE) {
  filt_df <- read.csv("../../../data/output/RPneg_0331analysis/X4_incl_list_merge_wt_hmdb/merged_hmdb_mcg_fit_inclusion_list.csv", header = TRUE)
}

colnames(filt_df)
```

```{r}
colnames(filt_df)[13:15] #G2
colnames(filt_df)[16:18] #G1
colnames(filt_df)[19:21] #G3
```


### calculate mean and log2Fold change
```{r}
filt_df$mean_G1 <- rowMeans(filt_df[,16:18], na.rm = TRUE)
filt_df$mean_G2 <- rowMeans(filt_df[,13:15], na.rm = TRUE)
filt_df$mean_G3 <- rowMeans(filt_df[,19:21], na.rm = TRUE)
filt_df$log2FC_R5posvsR5neg <- filt_df$mean_G2 - filt_df$mean_G3
filt_df$log2FC_R5posvsNaive <- filt_df$mean_G2 - filt_df$mean_G1
filt_df$log2FC_R5negvsNaive <- filt_df$mean_G3 - filt_df$mean_G1
summary(filt_df$log2FC_R5posvsR5neg)
```

### filtering by log2FC of R5posvsR5neg
```{r}
FC_thres <- 2
filt2_df <- filt_df[filt_df$log2FC_R5posvsR5neg > log(FC_thres,2) | 
                    filt_df$log2FC_R5posvsR5neg < -log(FC_thres,2), ]
length(unique(filt2_df$X))
```

## Write the table out
- This will be a temporary list which requires further merging with mummichog output to add or at least supplement information that is critical related.

```{r}

p_or_padj <- "rawPval" #padj rawPval; change the $pval as well
file_key <- "ttest_R5posvsR5neg"

#These parameters should have been set before.
# Med_thre <- 16.6 #log2-scale of 100,000
# pval_thre <- 0.05
# FC_thres <- 2
write.csv(filt2_df,paste0(output_dir,"filt_med_",as.character(Med_thre),"_", p_or_padj,"_",as.character(pval_thre),"_FC_",as.character(FC_thres),"_",file_key,".csv"), row.names = FALSE)
          
          

```


## Next step (optional and it is not that important seems to be!)
- merge it with mummichog output so that we may get some sorts of annotated information. (optional)
- Finally we will put these feature `FT###` into `featureChromatograms` to visualize the peaks.


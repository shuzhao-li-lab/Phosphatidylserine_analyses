---
title: "Statistical filtering and median filtering for inclusion list"
output: html_notebook
---


## Clean up the environment and load the library 

```{r, include=FALSE}
rm(list = ls())

library(xcms)
library(RColorBrewer)
library(pander)
library(magrittr)
library(pheatmap)
library(SummarizedExperiment)
library(dplyr)
library(tidyr)
library(ggpubr)
library(ggplot2)
```

## Load the data and have a look at

```{r}
getwd()
output_dir = "../../../data/output/RPneg_0331analysis/filt_incl_list/"
dir.create(output_dir)

# load statistical test full report
ttest_df <- read.table("../../../data/output/RPneg_031821run/cleanup_and_stat_test/ttest_equal_variance/ttest_res_full_report_R5posvsR5neg.txt", 
                       header = TRUE, sep = '\t')
ttest_df[1:5,1:5]
colnames(ttest_df)

```

## Create median across samples in each feature
```{r}
Med_thre <- 16.6 #log2-scale of 100,000
ttest_df$Median <- rowMedians(as.matrix(ttest_df[,13:21]),na.rm = TRUE)
# You can check by: ttest_df[1:10,c(13:21,ncol(ttest_df))]
nrow(ttest_df)
nrow(ttest_df[ttest_df$Median > Med_thre,])

```
- Most of the features are with median higher than than 100,000 integrated values. 



## Apply statistics and median filtering in each feature
- check both padj and Rawpval
```{r}
Med_thre <- 16.6 #log2-scale of 100,000
pval_thre <- 0.05

nrow(ttest_df)
nrow(ttest_df[ttest_df$pval < pval_thre & ttest_df$Median > Med_thre,])
nrow(ttest_df[ttest_df$padj < pval_thre & ttest_df$Median > Med_thre,])
```

```{r}
Med_thre <- 16.6 #log2-scale of 100,000
pval_thre <- 0.05

nrow(ttest_df)
nrow(ttest_df[ttest_df$pval < pval_thre & ttest_df$Median > Med_thre,])
nrow(ttest_df[ttest_df$padj < pval_thre & ttest_df$Median > Med_thre,])
```
- I decide to go with padj < 0.05 which include 760 to trim down.

## Write the table out
- This will be a temporary list which requires further merging with mummichog output to add or at least supplement information that is critical related.

```{r}
Med_thre <- 16.6 #log2-scale of 100,000
pval_thre <- 0.05
p_or_padj <- "rawPval" #padj rawPval; change the $pval as well
file_key <- "ttest_R5posvsR5neg"

filt_df <- ttest_df[ttest_df$pval < pval_thre & ttest_df$Median > Med_thre,]
write.csv(filt_df,paste0(output_dir,"filt_med_",as.character(Med_thre),"_", p_or_padj,"_",as.character(pval_thre),"_", file_key,".csv"), row.names = FALSE)
          
          

```

## Supplementary: include the fold change

### Read the table if needed.
```{r}
if(TRUE) {
  filt_df <- read.csv("../../../data/output/RPneg_0331analysis/X4_incl_list_merge_wt_hmdb/merged_hmdb_mcg_fit_inclusion_list.csv", header = TRUE)
}

colnames(filt_df)
```

### calculate mean and log2Fold change
```{r}
filt_df$mean_G1 <- rowMeans(filt_df[,15:17], na.rm = TRUE)
filt_df$mean_G2 <- rowMeans(filt_df[,18:20], na.rm = TRUE)
filt_df$mean_G3 <- rowMeans(filt_df[,21:23], na.rm = TRUE)
filt_df$log2FC_R5posvsR5neg <- filt_df$mean_G2 - filt_df$mean_G3
filt_df$log2FC_R5posvsNaive <- filt_df$mean_G2 - filt_df$mean_G1
filt_df$log2FC_R5negvsNaive <- filt_df$mean_G3 - filt_df$mean_G1
summary(filt_df$log2FC_R5posvsR5neg)
```

### filtering by log2FC of R5posvsR5neg
```{r}
FC_thres <- 2
filt2_df <- filt_df[filt_df$log2FC_R5posvsR5neg > log(FC_thres,2) | 
                    filt_df$log2FC_R5posvsR5neg < -log(FC_thres,2), ]
length(unique(filt2_df$X))
```



### write the table
```{r}
if(TRUE) {
  output_dir <- "../../../data/output/RPneg_0331analysis/X1.sup_filt_by_FC/"
  dir.create(output_dir)
}

write.csv(filt2_df,paste0(output_dir,"FC_",FC_thres,"_", "stat_filt_merged_hmdb_mcg_inclusion_list.csv") , row.names = FALSE)
```


## Next step
- merge it with mummichog output so that we may get some sorts of annotated information. (optional)
- Finally we will put these feature `FT###` into `featureChromatograms` to visualize the peaks.


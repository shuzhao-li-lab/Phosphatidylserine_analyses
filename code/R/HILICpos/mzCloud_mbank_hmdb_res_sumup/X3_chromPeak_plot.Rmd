---
title: "Evaluation of features that were tentatively annotated or filtered for MS/MS"
function: in this notebook, it is for generating profiles from inclusion list
output: html_notebook
---

## Clean up and remove existed files
```{r, include=FALSE}
rm(list = ls())

library(xcms)
library(RColorBrewer)
library(pander)
library(magrittr)
library(pheatmap)
library(SummarizedExperiment)
library(dplyr)
library(tidyr)
library(ggpubr)
library(ggplot2)
```

## Load the xdata object and set the output_directory

```{r}

getwd()

if(TRUE) {
  # When you want to reexamine certain peaks, and this provides the entry to reload xdata object.
  xdata <- readRDS("../../../../data/output/v0412_fix/HILICpos/xcms/cor_wt_binSize0.005/HILICpos_xcms_minFrac07_bw2_ppm1_sum_binSize0.005.rds")
  output_dir <- "../../../../data/output/manual_compiled_MS2_mzCloud_mbank_hmdb_res/incl_list_chromPeak/"
  dir.create(output_dir)
}

```


## load the inclusion list previously generated.

```{r annotation dataframe}
annot_df <- read.csv("../../../../data/output/manual_compiled_MS2_mzCloud_mbank_hmdb_res/reorg_manual_this_time/summarized_HILICpos_manual_input_mzCloud_mbank_hmdb_matched_spectra_in_Rafi_Sign_list.csv", header = TRUE)
colnames(annot_df)
```

```{r load inclusion list}
incl_l <- read.csv("../../../../data/output/MS2_Spectra_massbank_match_05152021/HILICpos/Significant_list/sorted_filt_med_16.6_padj_0.05_FC_1_ttest_R5posvsR5neg.csv", header = TRUE)
colnames(incl_l)
```

```{r merge inclusion list and MS2-matched annotation table}
m_df <- merge(incl_l,annot_df, on = "X")
```


## Create a subtitle 
- If you have merged table with mcg &/ hmdb_search results. Take `TRUE`
- If you are directly using the inclusion list created by statistical/median/FC filtering, Take `FALSE`

```{r}
if(TRUE) {
  m_df$sub_title <- paste0(m_df$X, "\t",m_df$name, "\n",
                             substring(m_df$score, 1, 80), "\n" ,
                             substring(m_df$log2FC_R5posvsR5neg,1,80))
} else {
  m_df$sub_title <- paste0(m_df$X ,"; posvsneg log2FC = ",round(m_df$log2FC_R5posvsR5neg,2),
                                             "; posvsNai log2FC = ",round(m_df$log2FC_R5posvsNaive,2),
                                             "; negvsNai log2FC = ",round(m_df$log2FC_R5negvsNaive),2)
}

```

## Sort the table by log2FC if you haven't sorted
```{r}
if(FALSE) {
  m_df$abs_log2FC_R5posvsR5neg <- abs(m_df$log2FC_R5posvsR5neg)
  m_df <- m_df %>% arrange(desc(abs_log2FC_R5posvsR5neg))
}

```


## Check the xdata
```{r}
xdata$sample_group
xdata$sample_name
```



## Evaluation
# TO-DO: It is still not done if want to get the chrom peak figure with only selected samples.
```{r}
# list_FT <- c(1:10,100:110)

list_FT <- m_df$X
#TO-DO: list_annotation 
if(TRUE) {
  group_colors <- c("#999999","#0000ff", "#ff0000" )
  names(group_colors) <- c("G1_Naive","G2_R5pos","G3_R5neg")
  sample_colors <- group_colors[xdata$sample_group]
  pdf(paste(output_dir,"incl_list","chromPeak_evaluation.pdf", sep = ""), width = 20, height = 10)
  par(mfrow = c(2, 2))
  for (i in list_FT) {
  
  feature_chroms <- featureChromatograms(xdata, features = i)
  plot(feature_chroms, col = sample_colors, xlab = "",
     peakBg = sample_colors[chromPeaks(feature_chroms)[, "sample"]],  sub = m_df[m_df$X == i,"sub_title"]) #as.character(i)
  }
  dev.off()
}


```


## Double check whether you get same plot from using the xcms notebook comparing to the function I paste here.
- Function deleted here. But the results actually show they are identical. So I think it is not the plotting function itself.
- But I may need to explore more to refine peaks better!
```{r}
if(TRUE) {
  list_FT <- m_df$X
  pdf(paste(output_dir,"Individual_feature_evaluation_v2.pdf", sep = ""), width = 10, height = 10)
  par(mfrow = c(4, 4))
  for (i in list_FT) {
  feature_chroms <- featureChromatograms(xdata, features = i)
  plotChromPeakDensity(feature_chroms, col = sample_colors, simulate = FALSE, # param = pdp,
                     peakBg = NA, # sample_colors[chromPeaks(feature_chroms)[, "sample"]],
                     peakType = "rectangle",
                     peakCol = sample_colors[chromPeaks(feature_chroms)[, "sample"]],
                     peakPch = 16, sub = m_df[m_df$X == i,"sub_title"])
  }
  dev.off()
}
```

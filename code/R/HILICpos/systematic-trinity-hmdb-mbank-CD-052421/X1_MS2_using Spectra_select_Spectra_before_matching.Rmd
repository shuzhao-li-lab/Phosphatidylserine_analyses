---
title: "MS2DDA_analysis_wt_Spectra_selection"
author: "Minghao Gong"
date: "5/15/2021;6/3/2021"
functionality: "massbank match wt DDA-MS2 data; also added hmdb"
note: "Don't do retention range as they are run in different system; also try to create a summary table for all the matched spectra"
output: html_document
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
rm(list=ls())
library(BiocStyle)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

# Goal
- export all data to mgf format
- a simple matching of experimental MS2

## How to use
- Start docker using
  ```
  docker run \
    -e PASSWORD=bioc \
    -p 8787:8787 \
    -v /Users/gongm/Documents/projects/M420_Subrbier_CHIKV/M420_Suhrbier_CHIKV_04132021:/home/rstudio/external \
    spectra_xcms:latest
  ```
- or 
  ```
  bash /Users/gongm/Documents/projects/M420_Subrbier_CHIKV/M420_Suhrbier_CHIKV_04132021/analysis_0413run/code/docker_run_SpectraTutorial4_MS2analysis.sh
  ```
  
- Enter `http://localhost:8787` in a web browser and log in with username
  `rstudio` and password `bioc`.

# MS data import and handling
```{r}
getwd()
```


```{r}
output_dir = "../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/MS2spectra_select4library_match/"
dir.create(output_dir)
```

## Get the full path to the mzML files of HILICpos and load the data
```{r, results=TRUE}
path <- "../../../../data/input/04282021_Rafi_HILIC_pos_AX_DeepScan/mzML/ddMS2_scan/" # without the final /

list.files(path, pattern = ".mzML")

#' Define the input files
fls <- paste0(path, "/", list.files(path, pattern = ".mzML"))
```


```{r, results=TRUE}
fls
```


```{r, load the files into object, results=TRUE}
library(Spectra)

#' Import the data
sps_all <- Spectra(fls, backend = MsBackendMzR())

```

## PrecursorMz intensity calculation
```{r read the same data using xcms and estimate precursor intensity}
od <- MSnbase::readMSData(fls, mode = "onDisk")
pints <- xcms::estimatePrecursorIntensity(od, ppm = 2)
```

```{r check if the spectra & MSn object matched}
# isTRUE(all.equal(rtime(od), rtime(sps_all)))
z = (rtime(od)==rtime(sps_all))
length(z[z ==FALSE]) #supposed to 0 and thus they are equal
```


```{r store the precursor Intensity back to sps subject}
sps_all$precursorIntensity <- pints
```

```{r}
sps_all$precursorIntensity[1:200]
```

```{r}
saveRDS(sps_all, file = paste0(output_dir,"sps_all_SpecObject_wt_PreInt.RDS")) 
# sps_all <- readRDS("stuff.RDS")
```


```{r}
#' List all available spectra variables (attributes)
spectraVariables(sps_all)
```

```{r in-mem-size}
print(object.size(sps_all), units = "MB")
```

### Check the DDA running procedure (Optional)
```{r}
sps_all$msLevel[1:200]
unique(sps_all$msLevel)
```


```{r}
sps_ms2 <- sps_all[sps_all$msLevel == 2]
print(
  paste0("spetra object number (in total): ", length(sps_all), "\n",
             "spetra object number (MS2): ",length(sps_ms2))
    )

saveRDS(sps_ms2, file = paste0(output_dir,"sps_ms2_SpecObject_wt_PreInt.RDS"))
```


```{r read sps_ms2 if needed}
if(TRUE) {
  sps_ms2 <- readRDS("../../../../data/output/MS2_Spectra_massbank_match_05152021/HILICpos/massbank_search_agst_Sign_list/sps_ms2_SpecObject_wt_PreInt.RDS")
}
```



```{r}
# get a list of Features (r/t median and RT range)
# FT_test_df <- read.csv("../../../../input/test4MS2_streamline_analysis/featureDefinitions_subset4test.csv")
FT_test_df <- read.csv("../../../../data/output/MS2_Spectra_massbank_match_05152021/HILICpos/Significant_list/sorted_filt_med_16.6_padj_0.05_FC_1_ttest_R5posvsR5neg.csv")
FT_test_df
```


```{r}
FT_condidate_l = FT_test_df$X # access the Feature ID.
precursor_candidate_l = FT_test_df$mzmed
rt_candidate_l = list()
for (i in (1:nrow(FT_test_df))) {
  rt_candidate_l[[i]] =  c(FT_test_df$rtmin[i], FT_test_df$rtmax[i])
}

```


```{r filter-precursor-mz}
#' Subset the dataset to MS2 spectra matching the m/z
sps_ms2based_on_pre_candid_l = list()
for (j in 1:length(precursor_candidate_l)) {
  mz <- precursor_candidate_l[j]
  sps_ms2based_on_pre_candid_l[[j]] <- filterPrecursorMz(sps_ms2, mz = mz + ppm(c(-mz, mz), 2))
  # print(j)
  rt_range <- rt_candidate_l[[j]]
  sps_ms2based_on_pre_candid_l[[j]] <- filterRt(sps_ms2based_on_pre_candid_l[[j]], rt = c(rt_range[1]-300,rt_range[2]+300)) #no retention selection so using 300
  if(length(sps_ms2based_on_pre_candid_l[[j]]) != 0) {
    sps_ms2based_on_pre_candid_l[[j]]$featureIdCandidate <- FT_condidate_l[[j]]
  }
  
}

```

```{r double-check how many groups of spectra associate with the precursorMz}
length(sps_ms2based_on_pre_candid_l)
```
```{r calculate how many spectra in each precursorMz}
sapply(sps_ms2based_on_pre_candid_l, function(x)length(x))
```


```{r}
sps_ms2based_on_pre_candid_l = sps_ms2based_on_pre_candid_l[sapply(sps_ms2based_on_pre_candid_l, function(x)length(x))!=0]
length(sps_ms2based_on_pre_candid_l)
sapply(sps_ms2based_on_pre_candid_l, function(x)length(x))
sapply(sps_ms2based_on_pre_candid_l[1:5], function(x)x$featureIdCandidate)
```

```{r Export the spectra of interest to a MGF file}
library(MsBackendMgf)

# Export the spectra of interest to a MGF file
output_dir_mgf <- paste0(output_dir, "spectra_mgf/")
dir.create(output_dir_mgf)
for (i in 1:length(sps_ms2based_on_pre_candid_l)) {
    export(sps_ms2based_on_pre_candid_l[[i]], backend = MsBackendMgf(), file =
             paste0(output_dir_mgf,
                    "sps_ms2_based_on_precursor_candidates_",
                    round(median(sps_ms2based_on_pre_candid_l[[i]]$precursorMz),4),
                    ".mgf"))
}
```


## Data processing and manipulation

### plot the spectra of candidate precursorMz, check if they are similar across RT.
```{r Plot the spectra, raw-ms2, fig.width = 7, fig.height = 7}
#' Plot the first spectrum
pdf(paste0(output_dir,"sps_ms2_based_on_inclusion_list.pdf"))
for (i in (1:length(sps_ms2based_on_pre_candid_l))) {
  if (length(sps_ms2based_on_pre_candid_l[[i]]) < 9) { # adjust the number if needed
    plot_num <- length(sps_ms2based_on_pre_candid_l[[i]]) } 
  else {
    plot_num <- 9 # adjust the number if needed
  }
  print(plot_num)
  plotSpectra(sps_ms2based_on_pre_candid_l[[i]][1:plot_num]) 
}
dev.off()

```


```{r filter-intensity}
#' Define a filtering function
low_int <- function(x, ...) {
    x > max(x, na.rm = TRUE) * 0.05
}
```


```{r filter-intensity}
#' Apply the function to filter the spectra
sps_ms2filt_norm_l = list()
if(TRUE) {
  for (i in (1:length(sps_ms2based_on_pre_candid_l))) {
    sps_ms2filt_norm_l[[i]] <- filterIntensity(sps_ms2based_on_pre_candid_l[[i]], intensity = low_int)
    
    # print(j)
    }
}


```

```{r raw-ms2-filtered, fig.width = 7, fig.height = 7}
#' Plot the first spectrum after filtering
# plotSpectra(sps_ms2filt_norm_l[[11]][1:4])
```

```{r normalize}
#' Define a function to *normalize* the intensities
norm_int <- function(x, ...) {
    maxint <- max(x[, "intensity"], na.rm = TRUE)
    x[, "intensity"] <- 100 * x[, "intensity"] / maxint
    x
}
#' *Apply* the function to the data

if(TRUE) {
  for (i in (1:length(sps_ms2filt_norm_l))) {
    sps_ms2filt_norm_l[[i]] <- addProcessing(sps_ms2filt_norm_l[[i]], norm_int)
      
    # print(j)
    }
}
```

```{r}
#' Get the intensities after normalization
intensity(sps_ms2filt_norm_l[[i]])[[1]]
```


```{r reset if needed}
if(FALSE) {
  #' Remove any processing steps
  sps_orig <- reset(sps)
  head(intensity(sps_orig)[[1]])
}
```




## Select spectrum based on its top precursorIntensity

```{r}
sps_select_l = list()
for (i in (1:length(sps_ms2filt_norm_l))) {
  sps_ms2filt_norm_l[[i]]$precursorIntensity
  order_ind <- order(sps_ms2filt_norm_l[[i]]$precursorIntensity, decreasing = TRUE)
  retained_ind <- sapply(order_ind, function(x)if(x<=3){TRUE}else{FALSE})
  sps_select_l[[i]] <- sps_ms2filt_norm_l[[i]][retained_ind]
}

```

## saveRDS for sps_select
```{r}
saveRDS(sps_select_l,paste0(output_dir,"sps_select_top3precursorIntensity_per_targeted_mz.Rds"))
```



# Appendix 1. Checksums with the sha256 algorithm

```{r}
notebookid <- "Spectra_selection"
```

# Appendix 2. Libraries metadata
```{r}
sess_output_dir <- "../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/session_info_massbank/"
dir.create(sess_output_dir)

dev_session_info   <- devtools::session_info()
utils_session_info <- utils::sessionInfo()

message("Saving `devtools::session_info()` objects in data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/session_info_hmdb_massbank/devtools_session_info.rds  ..")
saveRDS(dev_session_info, file = paste0(sess_output_dir, notebookid, "_devtools_session_info.rds"))
message("Done!\n")

message("Saving `utils::sessionInfo()` objects in data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/session_info_hmdb_massbank/utils_session_info.rds  ..")
saveRDS(utils_session_info, file = paste0(sess_output_dir, notebookid ,"_utils_info.rds"))
message("Done!\n")

dev_session_info$platform
dev_session_info$packages[dev_session_info$packages$attached==TRUE, ]
```



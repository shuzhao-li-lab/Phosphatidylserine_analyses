---
title: "HMDB"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```


```{r load the data}
sps_select_l  <- readRDS("../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/MS2spectra_select4library_match/sps_select_top3precursorIntensity_per_targeted_mz.Rds")
```


# Match with HMDB
```{r get all hmdb data}

library(MsBackendHmdb)

#' Get all MS2 spectra xml files and import data
if(FALSE) {
  fls <- dir("/home/rstudio/data/ hmdb_all_spectra/", full.names = TRUE, pattern = "ms_ms")
hmdb <- Spectra(fls, source = MsBackendHmdbXml(), nonStop = TRUE)
} else {
  load("/home/rstudio/data/hmdb.RData") # The RData will be loaded as hmdb
}

```


```{r create output folder for hmdb}
register(SerialParam())
output_dir1 = "../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/hmdb_search_agst_Sign_list/"
dir.create(output_dir1)
output_dir2 = "../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/hmdb_search_agst_Sign_list/matches_0.4/"
dir.create(output_dir2)
output_dir = output_dir2

```


```{r comparing with hmdb}

#' Document the start time
start_time <- Sys.time()

#' Identify spectra that contain a peak matching the precursorMz m/z of interest
res_l = list()
idx_l <- list()
sps_final_l <- list()
max_score_l <- list()
hmdb_best_match_l <- list()
threshold = 0.4
for (i in (1:length(sps_select_l))) { 
  has_mz <- containsMz(hmdb, mz = mean(sps_select_l[[i]]$precursorMz), ppm = 10)
  hmdb_with_mz <- hmdb[has_mz]
  res_l[[i]] <- Spectra::compareSpectra(sps_select_l[[i]], hmdb_with_mz, ppm = 5)
  
  if (is.null(nrow(res_l[[i]]))) {
    res_l[[i]] <- t(as.matrix(res_l[[i]]))
    colnames(res_l[[i]]) <- hmdb_with_mz$spectrum_id

  }
  
  
  #' find the best one if it pass threshold (e.g., 0.7), else drop the loop
  if(max(res_l[[i]]) > threshold) {
    idx_l[[i]] <- which(res_l[[i]] == max(res_l[[i]]), arr.ind = TRUE)
    print(idx_l[[i]])
    print(max(res_l[[i]]))
    #intensity(hmdb_with_mz[idx[2]])

    #' *Normalize* the HMDB data (if needed)
      # hmdb_with_mz <- addProcessing(hmdb_with_mz, norm_int)
      # This function is not required if load Rdata, which has been normalized already.

    #' Specifying a function to draw peak labels
    label_fun <- function(x) {
        ints <- unlist(intensity(x))
        mzs <- format(unlist(mz(x)), digits = 6)
        mzs[ints < 5] <- ""
        mzs
    }

    idx <- idx_l[[i]]
    sps_select <- sps_select_l[[i]]

    
    #' get the hmdb spectra object.
  if(max(res_l[[i]]) > threshold) {
    hmdb_best_match <- hmdb_with_mz[idx[2]]
    hmdb_best_match_l[[i]] <- hmdb_best_match
    }
    
    #' plot and export the best matching if passing dot-plot score > threshold.
    pdf(paste0(output_dir,"mirror_plot_","JAX_1stDryAnal","_spsSelectMz_",sps_select[idx[1]]$precursorMz, "_hmdbID_",hmdb_with_mz[idx[2]]$spectrum_id,".pdf"))
    plotSpectraMirror(sps_select[idx[1]], hmdb_with_mz[idx[2]], tolerance = 0.2,
                    labels = label_fun, labelPos = 2, labelOffset = 0.2,
                    labelSrt = -30, main = paste("hmdb",hmdb_best_match$compound_id,
                                                 hmdb_best_match$spectrum_id,
                                                 hmdb_best_match$predicted,
                                                 round(hmdb_best_match$precursorMz,4),"realdata",
                                                 round(sps_select[idx[1]]$precursorMz,4),sep = "|"))
    grid()
    dev.off()
  }

  

  #' export the scoring matrix & the annotations from hmdb
  #'' get mark of hmdb
  if(max(res_l[[i]]) > threshold) {
    sps_final_l[[i]] <- sps_select[idx[1]]
  sps_final_l[[i]]$db_source <- "hmdb"
  }
  
  #'' export those that have best matched.
  if(max(res_l[[i]]) > threshold) {
    sps_final_l[[i]]$db_score <- max(res_l[[i]])
    sps_final_l[[i]]$db_compound_id <- hmdb_best_match$compound_id
    sps_final_l[[i]]$db_predicted <- hmdb_best_match$predicted
    sps_final_l[[i]]$db_spectrum_id <- hmdb_best_match$spectrum_id
    sps_final_l[[i]]$db_precursorMz <- hmdb_best_match$precursorMz # important
    sps_final_l[[i]]$db_instrument_type <- hmdb_best_match$instrument_type
    
  }

  #'' export all the scoring
  # sps_final_l[[i]]$scoring_mtx_hmdb_Id <- names(res_l[[i]][idx[1],])
  # sps_final_l[[i]]$scoring_mtx_score <- as.numeric(res_l[[i]][idx[1],])
  
  #' testing the outcome
  max_score_l[[i]] <- max(res_l[[i]])
  print(max(res_l[[i]]))
  print(i)
  
  
  library(MsBackendMgf)

  #' Export the spectra to a MGF file
  if(max(res_l[[i]]) > threshold) {
    print("yes")
    export(sps_final_l[[i]], backend = MsBackendMgf(), file = paste0(output_dir,"hmdb_matched_wt_score_",round(max(res_l[[i]]),4),"more_",sps_select[idx[1]]$precursorMz, "_hmdbID_",hmdb_with_mz[idx[2]]$spectrum_id,".mgf"))
  }
}

#' Document the end time
end_time <- Sys.time()
end_time - start_time

```


# Appendix 0. Checksums with the sha256 algorithm
```{r}
saveRDS(sps_final_l,paste0(output_dir,"sps_final_l_hmdb_matched.Rds"))

saveRDS(hmdb_best_match_l,paste0(output_dir,"hmdb_best_match_list.Rds"))
```


# Appendix 1. Checksums with the sha256 algorithm

```{r}
notebookid <- "Spectra_match_MS2_with_hmdb"
```

# Appendix 2. Libraries metadata
```{r}
sess_output_dir <- "../../../../data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/session_info_massbank/"
dir.create(sess_output_dir)

dev_session_info   <- devtools::session_info()
utils_session_info <- utils::sessionInfo()

message("Saving `devtools::session_info()` objects in data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/session_info_hmdb_massbank/devtools_session_info.rds  ..")
saveRDS(dev_session_info, file = paste0(sess_output_dir, notebookid, "_devtools_session_info.rds"))
message("Done!\n")

message("Saving `utils::sessionInfo()` objects in data/output/systematic-trinity-hmdb-mbank-CD-052421/HILICpos/session_info_hmdb_massbank/utils_session_info.rds  ..")
saveRDS(utils_session_info, file = paste0(sess_output_dir, notebookid ,"_utils_info.rds"))
message("Done!\n")

dev_session_info$platform
dev_session_info$packages[dev_session_info$packages$attached==TRUE, ]
```
